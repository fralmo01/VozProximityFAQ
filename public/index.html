<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Chat Voz PRO</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            background-color: #1a1a1a;
            color: #eee;
            padding: 20px;
        }

        .box {
            background: #2b2b2b;
            padding: 20px;
            border-radius: 10px;
            max-width: 400px;
            margin: 0 auto;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        h1 {
            color: #4CAF50;
        }

        input {
            padding: 12px;
            width: 80%;
            border-radius: 5px;
            border: 1px solid #555;
            background: #333;
            color: white;
            margin-bottom: 10px;
        }

        button {
            padding: 12px 24px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            font-size: 16px;
            transition: 0.3s;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
        }

        #log {
            margin-top: 20px;
            font-size: 12px;
            color: #aaa;
            text-align: left;
            background: #000;
            padding: 10px;
            border-radius: 5px;
            height: 150px;
            overflow-y: auto;
            font-family: monospace;
            border: 1px solid #333;
        }

        .status-dot {
            height: 10px;
            width: 10px;
            background-color: #bbb;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .online {
            background-color: #28a745;
            box-shadow: 0 0 10px #28a745;
        }

        .error {
            color: #ff4444;
        }

        .info {
            color: #44aaff;
        }
    </style>
</head>

<body>

    <div class="box">
        <h1>üéôÔ∏è Proximity Chat</h1>

        <div id="connectionPanel">
            <p>Ingresa tu Gamertag exacto de Minecraft:</p>
            <input type="text" id="gamertagInput" placeholder="Ej: Steve">
            <br>
            <button onclick="iniciarChat()" id="btnConnect">üîå CONECTAR</button>
        </div>

        <div id="activePanel" style="display:none;">
            <h3><span class="status-dot online"></span><span id="displayGamertag">Usuario</span></h3>
            <p>Estado: <b>En L√≠nea y Escuchando</b></p>
            <button onclick="resumeAudio()" style="background:#ff9800; font-size:12px;">üîá ¬øNo escuchas? Clic
                aqu√≠</button>
        </div>

        <div id="log"></div>
    </div>

    <script>
        const socket = io();
        let myGamertag = "";
        let audioCtx = null; // Motor de audio GLOBAL (La correcci√≥n clave)
        let gainNode = null;

        // Sistema de Logs visuales
        function log(msg, type = 'normal') {
            const logDiv = document.getElementById('log');
            const color = type === 'error' ? '#ff5555' : (type === 'info' ? '#55ffff' : '#aaaaaa');
            logDiv.innerHTML += `<div style="color:${color}; border-bottom: 1px solid #222; padding: 2px;">> ${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(msg);
        }

        // 1. Inicializar Audio Context (Solo una vez)
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                log("‚úÖ Motor de Audio Iniciado", "info");
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume().then(() => log("üîä Audio reanudado por usuario"));
            }
        }

        // Bot√≥n de emergencia por si el audio se corta
        function resumeAudio() {
            initAudio();
            alert("Motor de audio reiniciado. Si sigues sin escuchar, verifica que el Bot/Amigo est√© a menos de 20 bloques.");
        }

        async function iniciarChat() {
            const input = document.getElementById("gamertagInput");
            myGamertag = input.value.trim();

            if (!myGamertag) { alert("¬°Escribe tu nombre!"); return; }

            // Activar Audio Context al hacer clic (Requisito del navegador)
            initAudio();

            try {
                // Pedir micr√≥fono
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                log("üé§ Micr√≥fono autorizado.");

                // Interfaz
                document.getElementById("connectionPanel").style.display = "none";
                document.getElementById("activePanel").style.display = "block";
                document.getElementById("displayGamertag").innerText = myGamertag;

                // Registrarse en el servidor
                socket.emit('register', myGamertag);
                log(`üì§ Registrado como: ${myGamertag}`, "info");

                // Comenzar a enviar audio
                startSendingAudio(stream);

            } catch (err) {
                log("‚ùå Error de micr√≥fono: " + err.message, "error");
                alert("Necesitas dar permiso de micr√≥fono para jugar.");
            }
        }

        function startSendingAudio(stream) {
            const mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = event => {
                if (event.data.size > 0 && socket.connected) {
                    socket.emit('voice', event.data);
                }
            };
            mediaRecorder.start(100); // Enviar cada 100ms para menor latencia
        }

        // --- RECEPCI√ìN DE AUDIO CORREGIDA ---
        socket.on('voice', async (data) => {
            // data = { audio, distance, user }

            // 1. Si el motor de audio no existe o est√° suspendido, no hacer nada (o intentar despertarlo)
            if (!audioCtx) return;

            try {
                // 2. Convertir Blob/Buffer a ArrayBuffer
                let arrayBuffer;
                if (data.audio instanceof ArrayBuffer) {
                    arrayBuffer = data.audio;
                } else {
                    arrayBuffer = await data.audio.arrayBuffer();
                }

                // 3. Decodificar (Esto fallaba antes si se acumulaban muchos contextos)
                const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

                // 4. Reproducir
                const source = audioCtx.createBufferSource();
                source.buffer = audioBuffer;

                const gainNode = audioCtx.createGain();

                // C√°lculo de volumen: 20 bloques = silencio. 0 bloques = 100% volumen.
                let volume = Math.max(0, 1 - (data.distance / 20));
                gainNode.gain.value = volume;

                source.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                source.start(0);

                // Debug visual ocasional (solo si est√° muy cerca para no spamear)
                if (volume > 0.8) {
                    // log(`üîä Recibiendo de ${data.user} (Vol: ${(volume*100).toFixed(0)}%)`, "info");
                }

            } catch (e) {
                console.error("Error reproduciendo frame:", e);
            }
        });

        socket.on('connect', () => {
            log("üü¢ Conectado al Servidor");
            if (myGamertag) socket.emit('register', myGamertag);
        });

        socket.on('disconnect', () => log("üî¥ Desconectado del Servidor", "error"));
    </script>
</body>

</html>