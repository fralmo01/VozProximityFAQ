<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOX PROXIMITY HUD</title>
    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Roboto+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <!-- Icon -->
    <link rel="icon" href="https://img.icons8.com/color/48/minecraft-main-character.png" type="image/x-icon">

    <style>
        :root {
            --bg-color: #0a0a0a;
            --glass-bg: rgba(20, 20, 20, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --primary-accent: #00ff88;
            /* Neon Green */
            --danger-accent: #ff004c;
            /* Neon Red */
            --text-color: #e0e0e0;
            --muted-text: #888;
            --font-display: 'Rajdhani', sans-serif;
            --font-mono: 'Roboto Mono', monospace;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-display);
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background-image:
                radial-gradient(circle at 10% 20%, rgba(0, 255, 136, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(255, 0, 76, 0.05) 0%, transparent 20%);
        }

        /* --- UTILS --- */
        .hidden {
            display: none !important;
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-center {
            justify-content: center;
        }

        /* --- GLASS CONTAINER --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
            padding: 2rem;
            width: 100%;
            max-width: 500px;
            transition: all 0.3s ease;
        }

        /* --- LOGIN VIEW --- */
        #login-view {
            text-align: center;
        }

        .logo {
            font-size: 3rem;
            font-weight: 700;
            letter-spacing: 4px;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
            margin-bottom: 2rem;
            color: white;
        }

        .input-group {
            margin-bottom: 2rem;
            width: 100%;
        }

        input[type="text"] {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            color: var(--primary-accent);
            font-family: var(--font-mono);
            font-size: 1.2rem;
            padding: 1rem;
            border-radius: 6px;
            text-align: center;
            outline: none;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus {
            border-color: var(--primary-accent);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.1);
        }

        select {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            padding: 0.5rem;
            margin-bottom: 1rem;
            border-radius: 6px;
            font-family: var(--font-mono);
            outline: none;
        }

        .visualizer-container {
            width: 100%;
            height: 60px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--glass-border);
        }

        .audio-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--primary-accent), #00cc6a);
            transition: width 0.05s linear;
            box-shadow: 0 0 15px var(--primary-accent);
        }

        .btn-start {
            background: var(--primary-accent);
            color: #000;
            border: none;
            padding: 1rem 2rem;
            font-family: var(--font-display);
            font-weight: 700;
            font-size: 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.2s;
        }

        .btn-start:hover {
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
        }

        .btn-start:disabled {
            background: #333;
            color: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* --- HUD VIEW --- */
        #hud-view {
            width: 90vw;
            max-width: 1200px;
            height: 85vh;
            display: grid;
            grid-template-rows: auto 1fr auto;
            gap: 1.5rem;
        }

        /* HUD Header */
        .hud-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--glass-border);
        }

        .user-status {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .avatar-glow {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #333;
            box-shadow: 0 0 10px #333;
            transition: all 0.1s;
        }

        .avatar-glow.active {
            background: var(--primary-accent);
            box-shadow: 0 0 20px var(--primary-accent);
        }

        .current-user {
            font-family: var(--font-mono);
            font-size: 1.1rem;
            color: var(--primary-accent);
        }

        /* HUD Main - Radar List */
        .radar-container {
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        /* Scrollbar */
        .radar-container::-webkit-scrollbar {
            width: 6px;
        }

        .radar-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        .radar-container::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        .radar-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .player-card {
            background: rgba(255, 255, 255, 0.03);
            border-left: 3px solid #555;
            padding: 1rem;
            margin-bottom: 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px;
            transition: all 0.3s ease;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .player-card.in-range {
            border-left-color: var(--primary-accent);
            background: rgba(0, 255, 136, 0.05);
        }

        .player-card.out-range {
            border-left-color: var(--danger-accent);
            opacity: 0.6;
        }

        .player-info {
            display: flex;
            flex-direction: column;
        }

        .player-name {
            font-weight: 700;
            font-size: 1.1rem;
            letter-spacing: 1px;
        }

        .player-details {
            font-family: var(--font-mono);
            font-size: 0.8rem;
            color: var(--muted-text);
            margin-top: 4px;
            display: flex;
            gap: 10px;
        }

        .status-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .bg-cave {
            background: #4a3b75;
            color: #cabaff;
        }

        .bg-scream {
            background: #5e1124;
            color: #ff8ca3;
            animation: pulseRed 1s infinite;
        }

        @keyframes pulseRed {
            0% {
                box-shadow: 0 0 0 0 rgba(220, 20, 60, 0.4);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(220, 20, 60, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(220, 20, 60, 0);
            }
        }

        .distance-indicator {
            font-family: var(--font-mono);
            font-size: 1.2rem;
            font-weight: bold;
        }

        /* HUD Footer - Controls */
        .hud-controls {
            background: rgba(0, 0, 0, 0.4);
            padding: 1rem;
            border-radius: 8px;
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        label {
            font-weight: 600;
            white-space: nowrap;
        }

        input[type="range"] {
            width: 100%;
            accent-color: var(--primary-accent);
            height: 4px;
            background: #333;
            border-radius: 2px;
            appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary-accent);
            cursor: pointer;
            box-shadow: 0 0 10px var(--primary-accent);
        }

        .btn-mute {
            background: transparent;
            border: 1px solid var(--danger-accent);
            color: var(--danger-accent);
            padding: 0.5rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-family: var(--font-mono);
            font-weight: bold;
            transition: all 0.2s;
        }

        .btn-mute.muted {
            background: var(--danger-accent);
            color: black;
            box-shadow: 0 0 15px rgba(255, 0, 76, 0.4);
        }
    </style>

    <!-- Dependencies -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <!-- Removed PeerJS -->
</head>

<body>

    <!-- VISTA 1: LOGIN -->
    <div id="login-view" class="glass-panel">
        <div class="logo">VOX PROXIMITY</div>

        <div class="input-group">
            <input type="text" id="username" placeholder="Ingresa tu Minecraft ID..." autocomplete="off">
        </div>

        <div class="input-group">
            <select id="mic-select">
                <option value="">Cargando micr√≥fonos...</option>
            </select>
        </div>

        <div class="visualizer-container">
            <div id="mic-bar" class="audio-bar"></div>
        </div>

        <button id="btn-join" class="btn-start" disabled>INICIAR SISTEMA</button>
        <p id="status-msg" style="margin-top: 10px; color: #666; font-size: 0.9rem;">Esperando acceso al micr√≥fono...
        </p>
    </div>

    <!-- VISTA 2: HUD -->
    <div id="hud-view" class="glass-panel hidden">
        <!-- Header -->
        <div class="hud-header">
            <div class="user-status">
                <div id="self-glow" class="avatar-glow"></div>
                <div class="current-user">Conectado como: <span id="display-username" style="color: white;">---</span>
                </div>
            </div>
            <div class="system-status" style="color: var(--primary-accent); font-size: 0.9rem;">
                ONLINE ‚óè
            </div>
        </div>

        <!-- Radar List -->
        <div id="radar-list" class="radar-container">
            <!-- JS Inject Players Here -->
        </div>

        <!-- Controls -->
        <div class="hud-controls">
            <button id="btn-toggle-mute" class="btn-mute">MIC ON</button>
            <div class="control-group">
                <label>Volumen General</label>
                <input type="range" id="master-volume" min="0" max="2" step="0.1" value="1">
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const MAX_DISTANCE = 60; // Metros
        const CHUNK_TIME_MS = 100; // Enviar audio cada 100ms

        // --- STATE ---
        let myUsername = null;
        let localStream = null;
        let mediaRecorder = null;
        let socket = null;
        let playersState = []; // Data from socket
        let isMuted = false;

        // --- DOM ELEMENTS ---
        const loginView = document.getElementById('login-view');
        const hudView = document.getElementById('hud-view');
        const usernameInput = document.getElementById('username');
        const micSelect = document.getElementById('mic-select');
        const btnJoin = document.getElementById('btn-join');
        const micBar = document.getElementById('mic-bar');
        const statusMsg = document.getElementById('status-msg');
        const radarList = document.getElementById('radar-list');
        const selfGlow = document.getElementById('self-glow');
        const displayUsername = document.getElementById('display-username');
        const btnToggleMute = document.getElementById('btn-toggle-mute');
        const masterVolumeSlider = document.getElementById('master-volume');

        // --- 1. INITIAL SETUP & LOGIN ---

        async function initMic(deviceId = null) {
            try {
                const constraints = {
                    audio: deviceId ? { deviceId: { exact: deviceId } } : true,
                    video: false
                };

                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }

                localStream = await navigator.mediaDevices.getUserMedia(constraints);

                // List Devices
                if (!deviceId) await listAudioInputs();

                btnJoin.disabled = false;
                statusMsg.textContent = "Micr√≥fono listo. Ingresa tu ID.";
                statusMsg.style.color = "#00ff88";

                // Mic Visualizer for Login
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioCtx.createMediaStreamSource(localStream);
                const analyser = audioCtx.createAnalyser();
                analyser.fftSize = 32;
                source.connect(analyser);

                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                function drawMic() {
                    analyser.getByteFrequencyData(dataArray);
                    let sum = 0;
                    for (let i = 0; i < dataArray.length; i++) sum += dataArray[i];
                    let avg = sum / dataArray.length;
                    micBar.style.width = Math.min(100, avg * 2) + "%";
                    if (!loginView.classList.contains('hidden')) requestAnimationFrame(drawMic);
                }
                drawMic();

            } catch (err) {
                console.error(err);
                statusMsg.textContent = "Error: Acceso al micr√≥fono denegado.";
                statusMsg.style.color = "#ff004c";
            }
        }

        async function listAudioInputs() {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const audioInputs = devices.filter(device => device.kind === 'audioinput');

            micSelect.innerHTML = '';
            audioInputs.forEach(device => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                option.text = device.label || `Micr√≥fono ${micSelect.length + 1}`;
                micSelect.appendChild(option);
            });
        }

        micSelect.addEventListener('change', (e) => {
            initMic(e.target.value);
        });

        initMic(); // Request permission on load

        btnJoin.addEventListener('click', () => {
            const name = usernameInput.value.trim();
            if (!name) return alert("Por favor ingresa tu Minecraft ID");
            if (!localStream) return alert("No se detect√≥ el micr√≥fono");

            myUsername = name;
            startGame();
        });

        // --- 2. GAME LOBBY LOGIC ---

        function startGame() {
            // UI Switch
            loginView.classList.add('hidden');
            hudView.classList.remove('hidden');
            displayUsername.textContent = myUsername;

            // Connect to Socket
            connectSocket();

            // Start Audio Transmission
            startAudioTransmission();
        }

        function connectSocket() {
            socket = io();

            socket.on('connect', () => {
                console.log("Socket connected:", socket.id);
                // REGISTER USERNAME
                socket.emit('register', myUsername);
            });

            // Update Player Positions for Radar
            socket.on('update-positions', (data) => {
                playersState = data;
                renderRadar(); // Update UI

                // Also Check Self-Glow logic based on talking?
                // We'll trust the visualizer logic for that.
            });

            // RECEIVE VOICE
            socket.on('voice', async ({ audio, distance }) => {
                if (!audio) return;

                try {
                    // 1. Blob Data
                    const audioBlob = new Blob([audio], { type: 'audio/webm;codecs=opus' });
                    const audioUrl = URL.createObjectURL(audioBlob);

                    // 2. Play
                    const audioEl = new Audio(audioUrl);

                    // 3. Volume Attenuation
                    // Max Volume at 0m, 0 Volume at 20m.
                    let volume = Math.max(0, 1 - (distance / 20));

                    // Apply Master Volume
                    volume *= parseFloat(masterVolumeSlider.value);

                    audioEl.volume = Math.min(1, Math.max(0, volume));

                    await audioEl.play();

                    // Cleanup
                    audioEl.onended = () => URL.revokeObjectURL(audioUrl);

                } catch (e) {
                    console.error("Error playing audio chunk", e);
                }
            });
        }

        function startAudioTransmission() {
            // Use MediaRecorder to send chunks
            // mimeType 'audio/webm;codecs=opus' is standard for efficient web audio
            let options = { mimeType: 'audio/webm;codecs=opus' };
            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                console.warn("Opus not supported, falling back to default");
                options = {};
            }

            mediaRecorder = new MediaRecorder(localStream, options);

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0 && !isMuted && socket && socket.connected) {
                    socket.emit('voice', event.data);

                    // Visual feedback for self
                    selfGlow.classList.add('active');
                    setTimeout(() => selfGlow.classList.remove('active'), 100);
                }
            };

            // Start recording and slice into chunks every CHUNK_TIME_MS
            mediaRecorder.start(CHUNK_TIME_MS);
        }

        // --- 3. UI CONTROLS ---

        btnToggleMute.addEventListener('click', () => {
            isMuted = !isMuted;
            if (isMuted) {
                btnToggleMute.textContent = "MUTED";
                btnToggleMute.classList.add('muted');
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.pause();
                }
            } else {
                btnToggleMute.textContent = "MIC ON";
                btnToggleMute.classList.remove('muted');
                if (mediaRecorder && mediaRecorder.state === 'paused') {
                    mediaRecorder.resume();
                }
            }
        });

        // --- 4. RADAR RENDERER (Keep existing logic but simplified) ---
        function renderRadar() {
            radarList.innerHTML = '';

            const me = playersState.find(p => p.name === myUsername);
            if (!me) return;

            playersState.forEach(player => {
                if (player.name === myUsername) return;

                // Calculate Distance
                const dx = me.x - player.x;
                const dy = me.y - player.y; // Height matters too
                const dz = me.z - player.z;
                const dist = Math.sqrt(dx * dx + dy * dy + dz * dz);

                const card = document.createElement('div');
                card.className = `player-card ${dist < 20 ? 'in-range' : 'out-range'}`;

                // Badges
                let badges = '';
                if (player.is_underground) badges += '<span class="status-badge bg-cave">üè† CUEVA</span>';

                card.innerHTML = `
                    <div class="player-info">
                        <div class="player-name">${player.name}</div>
                        <div class="player-details">
                            <span>${dist.toFixed(1)}m</span>
                            ${badges}
                        </div>
                    </div>
                    <div class="distance-indicator">
                        ${dist < 20 ? 'üîä' : 'üîá'}
                    </div>
                `;
                radarList.appendChild(card);
            });
        }
    </script>
</body>

</html>